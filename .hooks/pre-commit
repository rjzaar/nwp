#!/bin/bash
# Pre-commit hook for code quality checks

set -e

# Colors for output
# Respects NO_COLOR standard (https://no-color.org/)
if [ -n "${NO_COLOR:-}" ] || [ ! -t 1 ]; then
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
else
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
fi

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get list of staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No PHP files to check.${NC}"
    exit 0
fi

# Check if phpcs is available
if ! command -v phpcs &> /dev/null; then
    echo -e "${RED}phpcs not found. Please install PHP_CodeSniffer.${NC}"
    exit 1
fi

# Check if phpstan is available
if ! command -v phpstan &> /dev/null; then
    echo -e "${RED}phpstan not found. Please install PHPStan.${NC}"
    exit 1
fi

# Run phpcs on staged files
echo -e "${YELLOW}Running phpcs...${NC}"
PHPCS_FAILED=0
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        phpcs --standard=Drupal,DrupalPractice --extensions=php,module,inc,install,test,profile,theme "$FILE" || PHPCS_FAILED=1
    fi
done

if [ $PHPCS_FAILED -ne 0 ]; then
    echo -e "${RED}phpcs found coding standard violations.${NC}"
    echo -e "${YELLOW}Run 'phpcbf' to automatically fix some issues.${NC}"
    exit 1
fi

# Run phpstan analysis
echo -e "${YELLOW}Running phpstan...${NC}"
if ! phpstan analyse --configuration=phpstan.neon --no-progress; then
    echo -e "${RED}phpstan found errors.${NC}"
    exit 1
fi

echo -e "${GREEN}All checks passed!${NC}"
exit 0
