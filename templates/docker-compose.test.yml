# NWP Docker Compose Test Environment
# Use this for CI/CD testing outside of DDEV
#
# Usage:
#   docker compose -f docker-compose.test.yml up -d
#   docker compose -f docker-compose.test.yml exec cli ./vendor/bin/phpunit
#   docker compose -f docker-compose.test.yml exec cli ./vendor/bin/behat
#   docker compose -f docker-compose.test.yml down
#
# For DDEV-based testing, use: ddev exec ./vendor/bin/phpunit

version: '3.8'

services:
  # PHP CLI for running tests, drush, composer
  cli:
    image: drupal:10-php8.2-fpm
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html
      - composer-cache:/root/.composer/cache
    depends_on:
      - database
    environment:
      - SIMPLETEST_BASE_URL=http://web:8080
      - SIMPLETEST_DB=mysql://drupal:drupal@database/drupal
      - BROWSERTEST_OUTPUT_DIRECTORY=/var/www/html/web/sites/simpletest/browser_output
      - MINK_DRIVER_ARGS_WEBDRIVER=["chrome", {"browserName":"chrome","goog:chromeOptions":{"args":["--disable-gpu","--headless","--no-sandbox","--disable-dev-shm-usage"]}}, "http://chrome:4444"]

  # Nginx web server
  web:
    image: nginx:alpine
    ports:
      - "8080:8080"
    volumes:
      - .:/var/www/html:ro
      - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php

  # PHP-FPM for web requests
  php:
    image: drupal:10-php8.2-fpm
    volumes:
      - .:/var/www/html
    depends_on:
      - database
    environment:
      - SIMPLETEST_BASE_URL=http://web:8080
      - SIMPLETEST_DB=mysql://drupal:drupal@database/drupal

  # MariaDB database
  database:
    image: mariadb:10.6
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: drupal
      MYSQL_USER: drupal
      MYSQL_PASSWORD: drupal
    volumes:
      - db-data:/var/lib/mysql
    # Use tmpfs for faster CI tests
    tmpfs:
      - /var/lib/mysql

  # Chrome for Selenium/JavaScript tests
  chrome:
    image: selenium/standalone-chrome:latest
    # Increase shared memory for Chrome stability
    shm_size: '1gb'
    ports:
      - "4444:4444"
      - "5900:5900"  # VNC for debugging
      - "9222:9222"  # Chrome DevTools Protocol
    environment:
      - SE_NODE_MAX_SESSIONS=2
      - SE_NODE_SESSION_TIMEOUT=300

volumes:
  db-data:
  composer-cache:

networks:
  default:
    name: nwp-test
