# NWP Configuration File
# Copy to cnwp.yml and customize for your environment
#
# Status Legend:
#   [ACTIVE]  - Currently used by NWP scripts
#   [PLANNED] - Documented but not yet implemented
#   [DEFAULT] - Value shown is the hardcoded default if not specified

################################################################################
# SETTINGS - Global NWP Configuration
################################################################################
settings:
  # === STACK SETTINGS [ACTIVE] ===
  database: mariadb                # [ACTIVE] Database type: mariadb, mysql, postgres
  database_version: "10.11"        # [ACTIVE] Database version for DDEV
  php: 8.2                         # [ACTIVE] PHP version for DDEV

  # === STACK SETTINGS [PLANNED] ===
  # webserver: nginx               # [PLANNED] Always nginx in DDEV currently
  # os: ubuntu                     # [PLANNED] Always ubuntu for Linode currently

  # === CLI SETTINGS [PLANNED] ===
  # cli: y                         # [PLANNED] Install universal CLI wrapper
  # cliprompt: pl                  # [PLANNED] CLI command name (hardcoded as 'pl')

  # === DEPLOYMENT SETTINGS [ACTIVE] ===
  # linodeuse: testing/gitlab/all  # [ACTIVE] When to use Linode: testing, gitlab, all, or blank
  linodeuse:
  # urluse: testing/gitlab/all     # [ACTIVE] When to use custom URL: testing, gitlab, all, or blank
  urluse:
  url:                             # [ACTIVE] Base domain for live sites (e.g., nwpcode.org)

  # === PHP SETTINGS [ACTIVE] ===
  # These override hardcoded defaults in install.sh
  php_settings:
    memory_limit: 512M             # [ACTIVE] PHP memory limit
    max_execution_time: 600        # [ACTIVE] Max script execution time (seconds)
    upload_max_filesize: 100M      # [ACTIVE] Max upload file size
    post_max_size: 100M            # [ACTIVE] Max POST data size

  # === TIMEOUT SETTINGS [ACTIVE] ===
  timeouts:
    dns_propagation: 300           # [ACTIVE] DNS propagation wait (seconds)
    ssh_connection: 600            # [ACTIVE] SSH connection timeout (seconds)
    health_check: 10               # [ACTIVE] Health check interval (seconds)

  # === GITLAB SETTINGS ===
  # For local GitLab Docker installations and production GitLab servers
  gitlab:
    # Local Docker ports [ACTIVE]
    ports:
      ssh: 2222                    # [ACTIVE] GitLab SSH port
      http: 8080                   # [ACTIVE] GitLab HTTP port
      https: 8443                  # [ACTIVE] GitLab HTTPS port

    # Security hardening options [PLANNED]
    # Applied when running: ./git/gitlab_harden.sh --apply
    hardening:
      enabled: true                # [PLANNED] Enable hardening during setup
      disable_signups: true        # [PLANNED] Disable public user registration
      require_2fa: false           # [PLANNED] Require 2FA for all users
      password_min_length: 12      # [PLANNED] Minimum password length
      session_timeout: 60          # [PLANNED] Session timeout (minutes)
      ip_allowlist: []             # [PLANNED] Restrict to specific IPs
      audit_logging: true          # [PLANNED] Enable audit event logging
      # Security scanning in CI pipelines
      sast_enabled: true           # [PLANNED] Static Application Security Testing
      dependency_scanning: true    # [PLANNED] Dependency vulnerability scanning
      secret_detection: true       # [PLANNED] Detect secrets in commits

    # Repository mirroring [PLANNED]
    # Push mirrors to external services (GitHub, external GitLab)
    mirroring:
      enabled: false               # [PLANNED] Enable repository mirroring
      # targets:                   # [PLANNED] Mirror destinations
      #   - type: github
      #     url: https://github.com/username
      #     token_secret: github.api_token  # Reference to .secrets.yml
      #     mirror_protected_only: true

  # === ENVIRONMENT CONFIGURATION [PLANNED] ===
  # Default environment settings (can be overridden per recipe)
  environment:
    development:
      debug: true                  # [PLANNED] Enable debug mode
      xdebug: false                # [PLANNED] XDebug off by default
      database_import: always      # [PLANNED] Always import database
      stage_file_proxy: false      # [PLANNED] Disabled by default
    staging:
      debug: false                 # [PLANNED]
      database_sanitize: true      # [PLANNED] Sanitize database on import
      stage_file_proxy: true       # [PLANNED]
    production:
      debug: false                 # [PLANNED]
      database_sanitize: false     # [PLANNED]
      redis: true                  # [PLANNED] Enable Redis in production
      caching: aggressive          # [PLANNED]

  # === SERVICES CONFIGURATION [PLANNED] ===
  # Default services (can be overridden per recipe)
  services:
    redis:
      enabled: false               # [PLANNED] Redis disabled by default
      version: "7"                 # [PLANNED]
    solr:
      enabled: false               # [PLANNED] Solr disabled by default
      version: "8"                 # [PLANNED]
      core: drupal                 # [PLANNED]
    memcache:
      enabled: false               # [PLANNED]

  # === TESTING CONFIGURATION [ACTIVE] ===
  # Local testing tools and email safety
  testing:
    bats:
      enabled: true                # [ACTIVE] Install BATS testing framework via setup.sh
      run_on_commit: false         # [PLANNED] Run tests before commits (via hook)
    email:
      use_mailpit: true            # [ACTIVE] Use Mailpit for dev email capture
      reroute_dev: true            # [ACTIVE] Reroute dev emails to test address
      reroute_address: ""          # [ACTIVE] Leave empty to use Mailpit, or set specific address

  # === SITE MANAGEMENT [ACTIVE] ===
  delete_site_yml: true            # [ACTIVE] Remove site from cnwp.yml when deleted

  # === CI/CD CONFIGURATION [PLANNED] ===
  # Global CI settings - can be overridden per site
  ci:
    enabled: true                  # [PLANNED] Enable CI by default for new sites
    platform: gitlab               # [PLANNED] Primary CI platform: gitlab (NWP GitLab)
    auto_setup: false              # [PLANNED] Auto-setup CI during pl install

    # Pipeline stages to run
    stages:
      lint: true                   # [PLANNED] Run linting (phpcs, shellcheck)
      test: true                   # [PLANNED] Run tests (phpunit, behat)
      security: true               # [PLANNED] Security scanning
      deploy: false                # [PLANNED] Auto-deploy (manual by default)

    # Test configuration
    testing:
      phpcs: true                  # [PLANNED] PHP CodeSniffer
      phpstan: true                # [PLANNED] PHPStan static analysis
      phpstan_level: 5             # [PLANNED] PHPStan level (0-9)
      phpunit: true                # [PLANNED] PHPUnit tests
      behat: false                 # [PLANNED] Behat tests (disabled by default)

    # Coverage thresholds
    coverage:
      enabled: false               # [PLANNED] Enable coverage reporting
      threshold: 80                # [PLANNED] Minimum coverage percentage

    # Mirror to external services
    mirrors:
      github: false                # [PLANNED] Mirror to GitHub
      gitlab_com: false            # [PLANNED] Mirror to gitlab.com

  # === LIVE SITE SECURITY [ACTIVE] ===
  # Modules installed automatically when deploying to live servers (pl stg2live)
  live_security:
    enabled: true                  # [ACTIVE] Enable security hardening
    # Core security modules [ACTIVE] - installed automatically
    modules:
      - seckit                     # HTTP security headers, XSS/CSRF protection
      - honeypot                   # Spam bot protection (no user friction)
      - flood_control              # Brute force protection UI
      - login_security             # Login attempt limits, blocking
      - username_enumeration_prevention  # Prevents username discovery
    # Optional modules [PLANNED] - not auto-installed yet
    optional_modules:
      - antibot                    # Behavior-based bot detection
      - password_policy            # Strong password requirements
      - turnstile                  # Cloudflare CAPTCHA (requires API key)
    # Module configurations [PLANNED] - not applied yet
    seckit_config:
      xss:
        csp_policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
      clickjacking:
        x_frame_options: SAMEORIGIN
      ssl:
        hsts: true
        hsts_max_age: 31536000     # 1 year
    honeypot_config:
      protect_all_forms: true
      time_limit: 5                # Seconds before form can be submitted
    login_security_config:
      user_wrong_count: 5          # Failed attempts before soft block
      host_wrong_count: 10         # Failed attempts from IP before block
      activity_threshold: 100      # Max login attempts per hour

################################################################################
# SETUP - One-time Setup Options
################################################################################
setup:
  creategitlab: n                  # [PLANNED] Auto-create GitLab server

################################################################################
# PODCAST - Castopod Hosting Configuration
################################################################################
# Used by ./podcast.sh for automated podcast infrastructure setup
podcast:
  # Default Linode region for podcast servers
  linode_region: us-east
  # Linode plan type (g6-nanode-1 = $5/month, g6-standard-1 = $10/month)
  linode_type: g6-nanode-1
  # Default B2 region for media storage
  b2_region: us-west-004
  # Default subdomain for media files (e.g., media.example.com)
  media_subdomain: media
  # Docker Compose version to use
  compose_version: "3.9"
  # Castopod image tag
  castopod_image: castopod/castopod:latest
  # Default admin email template (uses base domain)
  admin_email_template: "admin@{domain}"

  # Example podcast site configurations (created by ./podcast.sh setup)
  # sites:
  #   podcast.example.com:
  #     linode_id: 12345678
  #     server_ip: 192.0.2.1
  #     b2_bucket: podcast-media
  #     b2_key_id: 000xxxxxxxxxxxxx
  #     dns_record_id: abc123
  #     created: 2024-12-31T10:00:00Z

################################################################################
# RECIPES - Site Installation Templates
################################################################################
recipes:
  # === DRUPAL RECIPES ===
  d:
    # [ACTIVE] Standard Drupal installation
    source: drupal/recommended-project:^10.2
    install_modules:               # [ACTIVE] Additional composer packages
    profile: standard              # [ACTIVE] Drupal install profile
    webroot: web                   # [ACTIVE] Document root
    auto: y                        # [ACTIVE] Auto-confirm installation
    # Options: TUI checkbox selections during install
    options:
      dev_modules:                    # Enable devel for debugging
      xdebug:                         # Step-through debugging with IDE
      environment_indicator: y        # [RECOMMENDED] Visual environment indicator in toolbar
      config_split:                   # Environment-specific config
      security_modules:               # Security hardening modules
      redis:                          # Object caching for performance
      cron:                           # Automated task scheduling
      backup:                         # Automated backups
      ssl:                            # HTTPS configuration
      migration:                      # Create migration folder for importing content

  os:
    # [ACTIVE] Open Social installation
    source: goalgorilla/social_template:dev-master
    install_modules:               # [ACTIVE]
    profile: social                # [ACTIVE]
    webroot: html                  # [ACTIVE]
    auto: y                        # [ACTIVE]
    # Options: TUI checkbox selections during install
    options:
      dev_modules:                    # Enable devel, webprofiler for debugging
      xdebug:                         # Step-through debugging with IDE
      stage_file_proxy:               # Proxy production files locally
      environment_indicator: y        # [RECOMMENDED] Visual environment indicator in toolbar
      config_split:                   # Environment-specific config
      security_modules:               # Security hardening modules
      redis:                          # Object caching for performance
      solr:                           # Advanced full-text search
      cron:                           # Automated task scheduling
      backup:                         # Automated backups
      ssl:                            # HTTPS configuration
      migration:                      # Create migration folder for importing content

  nwp:
    # [ACTIVE] NWP custom recipe with modules
    source: goalgorilla/social_template:dev-master
    install_modules: git@github.com:rjzaar/workflow_assignment.git drupal/ultimate_cron:^2.0.0-alpha7
    profile: social
    webroot: html
    auto: y
    # Options: Values with 'y' are pre-selected in TUI. Blank = available but not selected.
    options:
      # === Development (environment: dev) ===
      dev_modules:                    # Enable devel, webprofiler for debugging
      xdebug:                         # Step-through debugging with IDE
      stage_file_proxy:               # Proxy production files locally

      # === Configuration (environment: all) ===
      environment_indicator: y        # [RECOMMENDED] Visual environment indicator in toolbar
      config_split: y                 # [RECOMMENDED] Environment-specific config

      # === Staging (environment: stage) ===
      db_sanitize:                    # Anonymize user data on sync
      staging_domain:                 # Custom staging domain

      # === Security (environment: live) ===
      security_modules: y             # [RECOMMENDED] seckit, honeypot, login_security

      # === Performance (environment: live) ===
      redis:                          # Object caching for performance
      solr:                           # Advanced full-text search

      # === Production Infrastructure (environment: live) ===
      cron: y                         # [RECOMMENDED] Automated task scheduling
      backup: y                       # [RECOMMENDED] Automated backups
      ssl: y                          # [RECOMMENDED] HTTPS configuration
      cdn:                            # CDN integration

      # === Production Deployment (environment: prod) ===
      live_domain:                    # Production domain name
      dns_records:                    # Auto-configure DNS via Linode
      monitoring:                     # Uptime and performance monitoring

      # === Migration (environment: all) ===
      migration:                      # Create migration folder for importing content

  dm:
    # [ACTIVE] Divine Mercy recipe
    source: drupal/recommended-project:^10.2
    install_modules: git@github.com:rjzaar/divine_mercy.git
    profile: standard
    webroot: web
    auto: y
    options:
      dev_modules:                    # Enable devel for debugging
      xdebug:                         # Step-through debugging with IDE
      environment_indicator: y        # [RECOMMENDED] Visual environment indicator in toolbar
      config_split:                   # Environment-specific config
      security_modules:               # Security hardening modules
      redis:                          # Object caching for performance
      cron:                           # Automated task scheduling
      backup:                         # Automated backups
      ssl:                            # HTTPS configuration
      migration:                      # Create migration folder for importing content

  # === MOODLE RECIPE ===
  m:
    type: moodle                   # [ACTIVE] Recipe type
    source: https://github.com/moodle/moodle.git
    branch: MOODLE_404_STABLE      # [ACTIVE] Git branch
    webroot: .                     # [ACTIVE]
    sitename: "My Moodle Site"     # [ACTIVE] Site title
    auto: y                        # [ACTIVE]

  # === GITLAB RECIPE ===
  gitlab:
    type: gitlab                   # [ACTIVE] Recipe type
    source: https://gitlab.com/gitlab-org/gitlab-foss.git
    branch: master                 # [ACTIVE]
    webroot: .                     # [ACTIVE]
    sitename: "GitLab Instance"    # [ACTIVE]
    auto: y                        # [ACTIVE]

  # === ENHANCED EXAMPLE (shows all options) ===
  enhanced_example:
    source: goalgorilla/social_template:dev-master
    profile: social
    webroot: html
    auto: y

    # [ACTIVE] Development modules
    dev_modules: devel kint webprofiler stage_file_proxy

    # [ACTIVE] Deployment configuration
    reinstall_modules: custom_module   # Modules to reinstall during sync
    prod_method: rsync                 # Production method: git, tar, rsync
    prod_server: linode_primary        # Reference to linode.servers entry
    prod_domain: example.com           # Production domain name
    prod_path: /var/www/sitename       # Remote deployment path

    # [PLANNED] Directory paths - not yet implemented
    # private: ../private             # Private files directory
    # cmi: ../cmi                      # Configuration management directory

    # [PLANNED] Dev composer packages - not yet implemented
    # dev_composer: drupal/devel drupal/stage_file_proxy

    # [PLANNED] Per-recipe environment overrides - not yet implemented
    # environment:
    #   development:
    #     xdebug: true
    #   production:
    #     redis: true

    # [PLANNED] Per-recipe service overrides - not yet implemented
    # services:
    #   redis:
    #     enabled: true
    #   solr:
    #     enabled: true
    #     core: social

    # [PLANNED] Additional options - not yet implemented
    # force: false                    # Force config imports
    # lando: false                    # Use Lando instead of DDEV
    # secrets_file: .secrets.yml      # Custom secrets file location
    # prod_alias: user@prod.example.com:/var/www/sitename
    # prod_gitrepo: git@github.com:user/site.git
    # prod_gitdb: git@github.com:user/site-db.git

  # === TEST RECIPE ===
  test_nwp:
    source: goalgorilla/social_template:dev-master
    profile: social
    webroot: html
    auto: y
    dev_modules: devel kint webprofiler

  # === PODCAST RECIPE ===
  pod:
    type: podcast                  # [ACTIVE] Recipe type
    # Usage: ./install.sh pod podcast.example.com
    # Domain for the podcast (e.g., podcast.example.com)
    domain: podcast.example.com
    # Linode region for the server
    linode_region: us-east
    # B2 region for media storage
    b2_region: us-west-004
    # Media subdomain (e.g., media.example.com)
    media_subdomain: media
    auto: y                        # [ACTIVE]

################################################################################
# LINODE - Production Server Configuration
################################################################################
linode:
  # Default settings for new Linode instances [ACTIVE]
  defaults:
    image: linode/ubuntu22.04      # [ACTIVE] Default OS image
    region: us-east                # [ACTIVE] Default region
    type: g6-nanode-1              # [ACTIVE] Default instance type (1GB)
    gitlab_type: g6-standard-1     # [ACTIVE] GitLab needs 2GB minimum

  # Server configurations [ACTIVE]
  servers:
    linode_primary:
      ssh_user: deploy             # [ACTIVE] SSH username for deployment
      ssh_host: 203.0.113.10       # [ACTIVE] Server IP or hostname
      ssh_port: 22                 # [ACTIVE] SSH port
      ssh_key: ~/.ssh/nwp          # [ACTIVE] Path to SSH private key
      api_token: ${LINODE_API_TOKEN}  # [ACTIVE] Use environment variable
      server_ips:
        - 203.0.113.10             # [ACTIVE] Primary IP
      domains:
        - example.com              # [ACTIVE] Primary domain
        - www.example.com          # [ACTIVE] Additional domains

    linode_backup:
      ssh_user: deploy
      ssh_host: 203.0.113.20
      ssh_port: 22
      ssh_key: ~/.ssh/nwp
      api_token: ${LINODE_API_TOKEN}
      server_ips:
        - 203.0.113.20
      domains:
        - backup.example.com

################################################################################
# SITES - Auto-populated Site Registry
################################################################################
# Automatically populated when sites are created with install.sh
# Stores site metadata, production configuration, and deployment settings
sites:
  # Example site entry (created automatically by install.sh):
  # mysite:
  #   directory: /home/user/nwp/mysite    # [ACTIVE] Full path
  #   recipe: d                            # [ACTIVE] Recipe used
  #   environment: development             # [ACTIVE] Environment type
  #   created: 2024-12-28T10:30:00Z       # [ACTIVE] Creation timestamp
  #   purpose: indefinite                  # [ACTIVE] Site purpose
  #   installed_modules:                   # [ACTIVE] Additional modules
  #     - drupal/admin_toolbar
  #   live:                                # [ACTIVE] Live deployment config
  #     enabled: true
  #     domain: mysite.example.com
  #     server_ip: 203.0.113.10
  #     linode_id: shared
  #     type: shared
  #   ci:                                  # [PLANNED] Per-site CI configuration
  #     enabled: true                      # Enable CI for this site
  #     repo: git@git.nwpcode.org:nwp/mysite.git  # GitLab repository URL
  #     branch: main                       # Branch to run CI on
  #     stages:                            # Override global stages
  #       lint: true
  #       test: true
  #       security: true
  #       deploy: false
  #     mirrors:                           # Mirror destinations
  #       github: git@github.com:user/mysite.git
  #     notifications:                     # CI notifications
  #       email: admin@example.com
  #       slack_webhook: ""
  #   email:                               # [PLANNED] Per-site email configuration
  #     enabled: true                      # Enable email for this site
  #     address: mysite@nwpcode.org        # Site's email address
  #     direction: send                    # send = outgoing only, all = send + receive
  #     forward: admin@example.com         # Forward received emails to this address
  #     # Direction options:
  #     #   send - Site can send emails only (contact forms, notifications)
  #     #          No mailbox created, just SMTP credentials
  #     #   all  - Site can send AND receive emails
  #     #          Creates virtual mailbox with IMAP access
  #     # Forward options:
  #     #   If set, all received emails are forwarded to this address
  #     #   Works with direction: all (emails are stored AND forwarded)
  #     #   Useful for routing site inquiries to admin's main inbox
