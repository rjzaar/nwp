# F16: Mass Times Scraper & Display System

**Status:** PROPOSED
**Created:** 2026-02-10
**Author:** Rob, Claude Opus 4.6
**Priority:** Medium
**Depends On:** None (standalone, uses existing NWP infrastructure)
**Breaking Changes:** No
**Site:** mt.nwpcode.org

---

## 1. Executive Summary

### 1.1 Purpose

An automated system that discovers Catholic parishes within 20km of Ringwood, Melbourne (-37.8131, 145.2285), builds deterministic extraction templates for each parish's bulletins, websites, and other publications, and continuously harvests mass time data for display on a Drupal site at mt.nwpcode.org.

### 1.2 Core Design Principle

**Code first, AI last.** Parish bulletins and mass times pages follow predictable, repetitive formats. The system uses PDF structural analysis, regex pattern matching, CSS selectors, and diff-based change detection to extract mass times deterministically. LLM calls are a fallback for the small percentage of parishes where code-based extraction fails — not the default extraction method.

The key insight: a parish's bulletin format changes rarely (maybe once every few years when they switch CMS or redesign). Once you identify where mass times appear and what format they use, you can extract them with code indefinitely.

### 1.3 Integration with NWP

| Component | NWP Integration |
|---|---|
| Scraping pipeline | `mt/` directory (follows `fin/` pattern) |
| Bash wrapper & libraries | `lib/mass-times.sh`, sources `lib/ui.sh` |
| Configuration | `nwp.yml` under `mass_times:` section |
| API credentials | `.secrets.yml` under `mass_times` section |
| Drupal site | `sites/mt/` managed via `pl install mt` |
| Custom Drupal module | `modules/mass_times/` (follows `avc_moodle` pattern) |
| Deployment | `mt/deploy-mass-times.sh` (follows `fin/deploy-fin-monitor.sh`) |
| Cron scheduling | Via `setup-mass-times.sh` (follows `fin/setup-fin-monitor.sh`) |
| Email alerts | Via NWP `scripts/notify-email.sh` |
| Live hosting | mt.nwpcode.org on shared Linode |

---

## 2. System Architecture

### 2.1 Component Overview

```
~/nwp/
├── mt/                              # Mass times scraping pipeline
│   ├── mass-times.sh                # Main bash wrapper (like fin-monitor.sh)
│   ├── run-mass-times.sh            # Venv wrapper (auto-generated by setup)
│   ├── setup-mass-times.sh          # Server setup script
│   ├── deploy-mass-times.sh         # Deploy to production
│   ├── mass-times.conf              # Generated config (from nwp.yml)
│   ├── mass-times.log               # Runtime log
│   ├── .venv/                       # Python virtual environment
│   ├── src/                         # Python source code
│   │   ├── __init__.py
│   │   ├── discovery.py             # Parish discovery module
│   │   ├── scraper.py               # Web/PDF scraping
│   │   ├── template_builder.py      # Automated template building (code-based)
│   │   ├── extractor.py             # Three-tier extraction
│   │   ├── parser.py                # Time/day/section regex parsing
│   │   ├── validator.py             # Extraction validation
│   │   ├── drupal_sync.py           # Push data to Drupal via JSON:API
│   │   ├── models.py                # Data models
│   │   └── config.py                # Config loader
│   ├── templates/                   # Parish extraction templates (JSON)
│   │   ├── sacred-heart-croydon.json
│   │   ├── our-lady-ringwood.json
│   │   └── ...
│   ├── data/                        # Raw scraped content archive
│   │   ├── bulletins/               # Downloaded PDFs
│   │   └── pages/                   # Saved HTML snapshots
│   └── tests/                       # Python tests
│       ├── test_discovery.py
│       ├── test_parser.py
│       ├── test_template_builder.py
│       ├── test_extractor.py
│       └── fixtures/
├── modules/mass_times/              # Custom Drupal module
│   ├── mass_times.info.yml
│   ├── mass_times.module
│   ├── mass_times.install
│   ├── mass_times.routing.yml
│   ├── mass_times.services.yml
│   ├── config/
│   │   └── install/                 # Default config
│   └── src/
│       ├── Controller/
│       ├── Form/
│       ├── Plugin/Block/
│       └── Commands/                # Drush commands
├── lib/mass-times.sh                # NWP library (pl integration)
└── sites/mt/                        # Drupal site (created via pl install)
```

### 2.2 Data Flow

```
1. Discovery (one-time + monthly refresh)
   Google Places API / Archdiocese directory
   → Parish list with locations & source URLs
   → Stored in database

2. Template Building (one-time per parish, re-triggered on format change)
   Fetch 3-4 bulletins/pages
   → PDF structural analysis (pdfplumber coordinates)
   → Regex pattern detection (time, day, section headings)
   → CSS selector identification (web pages)
   → iCal/structured data detection
   → Diff across bulletins to classify static vs dynamic sections
   → Parish Extraction Template (JSON)
   → Validate template against held-out bulletins

3. Extraction Pipeline (scheduled, per parish)
   Fetch latest bulletin/page
   → Tier 1: Static check + keyword scan (no LLM)
   → Tier 2: Code-based template extraction (regex, selectors, PDF regions)
   → Tier 3: LLM fallback (Sonnet, rare)
   → Validated mass times JSON

4. Drupal Sync
   Validated mass times
   → JSON:API push to mt.nwpcode.org
   → Parish nodes updated
   → Map/search/listing refreshed

5. User Feedback
   "Report incorrect time" on mt.nwpcode.org
   → Re-scrape triggered
   → Template recalibration
```

---

## 3. Parish Discovery Module

### 3.1 Initial parish list compilation

- 3.1.1 Query Google Places API for "Catholic Church" within 20km radius of Ringwood coordinates (-37.8131, 145.2285).
- 3.1.2 Scrape the Melbourne Archdiocese parish directory (melbournecatholic.org) for parishes in the eastern suburbs using BeautifulSoup/CSS selectors.
- 3.1.3 Cross-reference with MassTimes.org listings for the region.
- 3.1.4 Deduplicate by name, address, and proximity (two entries within 100m treated as duplicate).
- 3.1.5 Store in the `parishes` database table.

### 3.2 Parish metadata enrichment

- 3.2.1 For each parish, collect: official name, address, lat/lng, phone, website URL, Facebook page, email.
- 3.2.2 Geocode addresses via Nominatim (free, OSM-based). Google Geocoding API as fallback.
- 3.2.3 Calculate exact distance from Ringwood centre using Haversine formula.
- 3.2.4 Flag parishes on the boundary (18-22km) for manual inclusion/exclusion decision.

### 3.3 Source discovery per parish

- 3.3.1 Crawl each parish website to identify: bulletin/newsletter page, mass times page, calendar page, announcements page. Use link text matching (`re.search(r'mass.?times|bulletin|newsletter|liturgy|schedule', text, re.I)`) and URL path matching.
- 3.3.2 Check for bulletin PDF archive (many parishes keep 6-12 months of weekly PDFs). Detect PDF links via `<a href="...\.pdf">` patterns.
- 3.3.3 Check for iCal feeds (`.ics` links, `<link rel="alternate" type="text/calendar">`, common calendar platform URLs like Google Calendar embeds).
- 3.3.4 Check for structured data: `schema.org/Church` markup, `schema.org/Event` microdata, JSON-LD blocks containing mass/service times.
- 3.3.5 Check for parish platform usage (Flocknote, ParishSOFT, etc.) by detecting known URL patterns, platform-specific CSS classes, or meta tags.
- 3.3.6 Record all discovered URLs in `source_endpoints` table, classified by type: `ical_feed`, `structured_data`, `website_page`, `pdf_bulletin`, `facebook_page`. Priority order reflects extraction reliability — iCal and structured data first.

### 3.4 Expected scope

Approximately 30-40 Catholic parishes within the 20km radius, covering Ringwood, Croydon, Mitcham, Nunawading, Doncaster, Lilydale, Mooroolbark, Wantirna, Knox, Ferntree Gully, Vermont, Blackburn, Box Hill, Healesville fringe, and surrounding areas.

---

## 4. Template Building Phase (Code-Based)

This phase replaces what would traditionally be an AI analysis step. Instead of sending documents to an LLM, the system uses PDF parsing, regex pattern detection, and structural analysis to build extraction templates automatically.

### 4.1 Historical data collection

- 4.1.1 For each parish, download 3-4 recent bulletins (or as many as available from the bulletin archive page).
- 4.1.2 Capture the current mass times web page HTML (if one exists).
- 4.1.3 If an iCal feed or structured data source was discovered, no template building is needed — these are already machine-readable.

### 4.2 Source type classification

Before template building, classify each parish into one of these categories (in priority order):

| Priority | Source Type | Extraction Method | Template Needed? |
|---|---|---|---|
| 1 | iCal feed | Parse `.ics` with `icalendar` library | No |
| 2 | Structured data (schema.org/JSON-LD) | Parse with `extruct` or `json` | No |
| 3 | HTML page with consistent structure | CSS selectors + regex | Yes (simple) |
| 4 | PDF bulletin with text layer | PDF region extraction + regex | Yes |
| 5 | PDF bulletin (image-only) | OCR (`pytesseract`) + regex | Yes |
| 6 | No machine-readable source | Manual entry or LLM assist | N/A |

Parishes in categories 1-2 need no template at all — their data is already structured. Categories 3-4 cover the majority of remaining parishes. Category 5 is uncommon. Category 6 is the only case requiring human intervention or LLM.

### 4.3 Web page template building

For parishes with a dedicated mass times web page:

- 4.3.1 **Fetch and parse HTML** with BeautifulSoup.
- 4.3.2 **Identify the mass times section** using a ranked list of heuristics:
  1. Look for headings (`h1`-`h6`) matching known patterns: `r'mass\s*times?|liturgy\s*schedule|weekend\s*mass|weekday\s*mass|service\s*times?'` (case-insensitive).
  2. Look for elements with id/class attributes containing `mass`, `times`, `schedule`, `liturgy`.
  3. Look for `<table>` elements containing day names and time patterns.
  4. Look for `<ul>`/`<ol>` elements containing time patterns.
- 4.3.3 **Record CSS selectors** for the identified section. Use the most specific stable selector (prefer id-based, then class-based, then positional).
- 4.3.4 **Extract time patterns** from the section text using regex:
  ```
  TIME:    r'(\d{1,2}[:.]\d{2}\s*[AaPp]\.?[Mm]\.?)'
  ALT:     r'(\d{1,2}\s*[AaPp]\.?[Mm]\.?)'        # "9am" without minutes
  24H:     r'(\d{2}:\d{2})'                         # 24-hour format
  ```
- 4.3.5 **Extract day patterns** using regex:
  ```
  FULL:    r'(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)'
  ABBREV:  r'(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\.?'
  RANGE:   r'(Monday\s*[-–to]+\s*Friday|Weekday|Weekend)'
  ```
- 4.3.6 **Build day→time mappings** by parsing proximity: times appearing after a day name (within the same block/row/list-item) are associated with that day.
- 4.3.7 **Store the template** with CSS selectors, regex patterns, and expected structure.

### 4.4 PDF bulletin template building

For parishes whose primary source is a PDF bulletin:

- 4.4.1 **Extract text with coordinates** using `pdfplumber`. For each text element, record: page number, x/y position, font size, font name, and the text content.
- 4.4.2 **Identify the mass times section** using the same heading/keyword regexes as 4.3.2, but operating on the extracted text elements.
- 4.4.3 **Define a bounding region**: the rectangular area (page, x_min, y_min, x_max, y_max) that contains all mass-times-related text. Add a small margin (20pt) for tolerance.
- 4.4.4 **Extract time and day patterns** from text within the bounding region using the same regexes as 4.3.4-4.3.5.
- 4.4.5 **Diff across multiple bulletins** to classify sections as static or dynamic:
  - Extract text from the bounding region of each downloaded bulletin.
  - If the mass times text is identical (or near-identical by Levenshtein distance < 5%) across 3+ bulletins, mark the section as **static**.
  - If it changes, mark as **dynamic** and record which parts change (typically temporary cancellations, holiday additions).
- 4.4.6 **Store the template** with page number, bounding region coordinates, static/dynamic classification, font characteristics of the heading, and extracted baseline times.

### 4.5 Change indicator detection

For both web and PDF sources, build a list of change indicators by scanning bulletin text:

- 4.5.1 Compile a default keyword list: `["no mass", "mass cancelled", "cancelled", "changed to", "note:", "please note", "no .* this week", "instead", "will not be held", "moved to", "rescheduled"]`.
- 4.5.2 Scan all downloaded bulletins for occurrences of these keywords near the mass times section.
- 4.5.3 Record any additional parish-specific change phrases found (e.g., "Father will be away").
- 4.5.4 Store the change indicator list in the template.

### 4.6 Parish Extraction Template format

Each template is stored as a JSON file in `mt/templates/`:

```json
{
  "parish_id": "sacred-heart-croydon",
  "parish_name": "Sacred Heart Parish, Croydon",
  "source_priority": ["website_page", "pdf_bulletin"],
  "source_type": "website_page",
  "extraction_method": "css_selector_regex",
  "web_template": {
    "url": "https://sacredheartcroydon.org.au/mass-times",
    "section_selector": "#mass-times-content",
    "fallback_selectors": [".field--name-body", "article .content"],
    "time_regex": "\\d{1,2}[:.]\\d{2}\\s*[AaPp]\\.?[Mm]\\.?",
    "day_regex": "(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)",
    "encoding": "utf-8"
  },
  "pdf_template": {
    "bulletin_page_url": "https://sacredheartcroydon.org.au/bulletin",
    "pdf_link_pattern": "bulletin.*\\.pdf",
    "mass_times_page": 1,
    "bounding_region": {"x_min": 350, "y_min": 100, "x_max": 580, "y_max": 400},
    "heading_text": "Mass Times",
    "heading_font_size": 14.0,
    "section_static": true
  },
  "baseline_times": {
    "Saturday": ["6:00 PM"],
    "Sunday": ["8:00 AM", "10:00 AM", "5:30 PM"],
    "Monday": ["9:15 AM"],
    "Tuesday": ["9:15 AM"],
    "Wednesday": ["9:15 AM"],
    "Thursday": ["9:15 AM"],
    "Friday": ["9:15 AM"]
  },
  "change_indicators": ["No Mass", "Mass cancelled", "changed to", "Note:", "Please note"],
  "language_markers": ["Italian", "Vietnamese", "Latin", "Polish"],
  "special_mass_markers": ["Vigil", "Reconciliation", "Adoration", "Latin", "Children"],
  "validation_rules": {
    "min_weekly_masses": 5,
    "max_weekly_masses": 20,
    "expected_sunday_count": 3,
    "alert_if_all_change": true
  },
  "template_version": 1,
  "created_at": "2026-02-10T00:00:00Z",
  "last_validated": "2026-02-10T00:00:00Z",
  "validation_accuracy": 0.95,
  "build_method": "automated",
  "notes": "Bulletin published every Thursday evening. Website mass times page is the canonical source and updated quarterly."
}
```

### 4.7 Template validation

- 4.7.1 For each template, run the extraction logic against the held-out bulletins/pages (ones not used during template building) and compare against the baseline times.
- 4.7.2 Calculate accuracy score per template (target: > 90%).
- 4.7.3 Parishes where automated template building produces accuracy < 85% are flagged for manual review. These are candidates for manual template adjustment or, as a last resort, LLM-assisted extraction (see 5.3.9).
- 4.7.4 Store validation results for ongoing quality tracking.

---

## 5. Automated Extraction Pipeline

### 5.1 Scheduling

- 5.1.1 Each parish has an independent scrape schedule based on its source type:
  - iCal feeds: check weekly (data is structured, changes are rare).
  - Web pages: check every 48 hours.
  - PDF bulletins: check on the day after the parish's known bulletin publish day.
- 5.1.2 Default: check all parishes every 48 hours.
- 5.1.3 Increase frequency to daily during Advent, Lent, Easter, and Christmas periods.
- 5.1.4 Cron managed via `setup-mass-times.sh` following `fin/` pattern. Main cron entry runs the orchestrator; individual parish timing is managed in Python.

### 5.2 Fetch stage

- 5.2.1 Download the latest bulletin PDF or scrape the mass times web page using `httpx` (static) or `Playwright` (JS-rendered).
- 5.2.2 For PDFs: detect if it is a new bulletin (SHA256 hash comparison) — skip processing if unchanged.
- 5.2.3 For web pages: diff against previous capture — skip if unchanged.
- 5.2.4 Handle failures: retry 3 times with exponential backoff, then send alert email via NWP `notify-email.sh`.
- 5.2.5 Respect `robots.txt`, add minimum 2-second delays between requests to same domain, identify with a polite User-Agent string.
- 5.2.6 Archive all fetched content to `mt/data/` with timestamps for future analysis.

### 5.3 Extraction stage (three-tier approach)

**Tier 1 — Static confirmation (no LLM, zero cost):**
- 5.3.1 For parishes where template building determined mass times are static (do not change week to week), use the stored `baseline_times` from the template.
- 5.3.2 Still fetch the bulletin/page to scan for change indicators (keywords from the template's `change_indicators` list).
- 5.3.3 Run a simple text comparison: extract text from the mass times section (using stored CSS selectors or PDF bounding region) and compare against previous extraction. If text similarity > 95% (by difflib.SequenceMatcher ratio) and no change indicators found, confirm baseline times are still current.
- 5.3.4 If change indicators detected or text similarity drops below 95%, escalate to Tier 2.

**Tier 2 — Code-based template extraction (no LLM, near-zero cost):**
- 5.3.5 **iCal sources:** Parse the `.ics` feed using the `icalendar` Python library. Filter events by summary/description matching mass-related keywords. Extract day, time, recurrence rules (`RRULE`), and exceptions (`EXDATE`). This is fully deterministic.
- 5.3.6 **Structured data sources:** Parse JSON-LD or microdata using `extruct`. Extract event times, locations, and recurrence. Fully deterministic.
- 5.3.7 **Web page sources:** Fetch the page, select the mass times section using the template's CSS selectors, extract text, and apply the template's time/day regexes to build day→time mappings. Handle common structures:
  - **Tables:** Parse `<table>` rows where column 1 is day and column 2+ are times.
  - **Definition lists:** Parse `<dt>` as day, `<dd>` as times.
  - **Paragraphs/list items:** Parse each item looking for `day: time, time` or `day time time` patterns.
- 5.3.8 **PDF sources:** Extract text from the template's bounding region using `pdfplumber.crop()`. Apply time/day regexes. If the section is static and text matches baseline, confirm. If dynamic, parse the full text for updated times.
- 5.3.9 If code-based extraction returns fewer times than `validation_rules.min_weekly_masses` or fails to find the expected section (selector/region returns empty), escalate to Tier 3.

**Tier 3 — LLM fallback (Sonnet, low cost, rare):**
- 5.3.10 Used when Tier 2 code-based extraction fails: section not found, format changed, or extraction produced implausible results.
- 5.3.11 Send the extracted text (full page/document text, not just a section) to Claude Sonnet with a structured prompt:
  ```
  Extract all Catholic mass times from this text. Return JSON:
  {"times": [{"day": "Sunday", "time": "10:00 AM", "type": "Regular", "language": "English", "notes": ""}]}
  Known baseline times for this parish: {baseline_times}
  Flag any differences from the baseline.
  ```
- 5.3.12 Parse the structured JSON response. If Sonnet returns low-confidence or unparseable results, log the failure and flag for manual review — do not escalate further (Opus is not cost-justified for routine extraction).
- 5.3.13 Cost per extraction: ~$0.005-0.02.
- 5.3.14 After a Tier 3 extraction succeeds, compare the result against the template. If the template's selectors/regions are now stale, trigger template rebuilding (Section 6.1).

### 5.4 Validation stage

- 5.4.1 Compare extracted times against the template's `validation_rules` (min/max counts, expected patterns).
- 5.4.2 Compare against previous week's times — flag if >50% of times changed simultaneously (likely extraction error rather than genuine change).
- 5.4.3 Cross-reference: if a parish has multiple sources (website + bulletin + iCal), compare results. Prefer iCal > structured data > web page > PDF.
- 5.4.4 Classify results as: `confirmed` (high confidence), `provisional` (low confidence, publish with caveat), or `flagged` (needs human review, do not publish).

### 5.5 Storage

- 5.5.1 Store raw fetched content (PDF/HTML) in `mt/data/` with timestamps.
- 5.5.2 Store extracted mass times in normalised database tables.
- 5.5.3 Maintain full history: every extraction is a new record, previous records are preserved.
- 5.5.4 Track provenance: which source, which extraction tier, confidence score, extraction timestamp.

---

## 6. Adaptive Maintenance (Ongoing)

### 6.1 Format change detection

- 6.1.1 If a parish's web page structure changes (CSS selectors return empty, different HTML structure), Tier 2 extraction will fail and escalate to Tier 3.
- 6.1.2 After 2 consecutive Tier 3 escalations for the same parish, automatically trigger template rebuilding: re-fetch the page, re-run the template building logic from Section 4.3/4.4, and generate a new template.
- 6.1.3 Diff the new template against the old template and log what changed (new selectors, new region coordinates, etc.).
- 6.1.4 Send email notification about the format change detection.

### 6.2 Seasonal pattern detection

- 6.2.1 After 6+ months of operation, run statistical analysis on the extraction history per parish to identify recurring patterns:
  - Group extractions by calendar month.
  - Detect if certain months consistently add/remove specific mass times (e.g., "Lent always adds a 7pm Wednesday Mass").
  - Use simple frequency counting: if a change appears in the same calendar period across 2+ years, flag it as seasonal.
- 6.2.2 Seasonal expectations are added to the template's `validation_rules` to reduce false alerts during known variation periods.

### 6.3 New parish detection

- 6.3.1 Monthly re-run of the discovery module to detect new parishes, merged parishes, or closed parishes.
- 6.3.2 New parishes enter the template building phase automatically.
- 6.3.3 Closed/merged parishes are flagged for manual confirmation before deactivation.

### 6.4 Community feedback loop

- 6.4.1 The Drupal frontend includes a "Report incorrect time" webform per parish.
- 6.4.2 User reports trigger an immediate re-scrape and Tier 2/3 extraction of the affected parish.
- 6.4.3 Confirmed corrections are applied to the baseline times in the template.
- 6.4.4 Reports are tracked in the `user_reports` table and reviewed via Drupal admin.

---

## 7. Database Schema

Uses MariaDB 10.11 (NWP default), managed via Drupal's entity system for content and custom tables for pipeline state.

### 7.1 Drupal entities (managed via Field API)

**Content type: Parish (`parish`)**
- Title (church name)
- `field_address` (text_long) — street address
- `field_location` (geofield) — lat/lng coordinates
- `field_distance` (decimal) — km from Ringwood
- `field_website` (link) — parish website URL
- `field_bulletin_url` (link) — bulletin page URL
- `field_phone` (telephone)
- `field_email` (email)
- `field_archdiocese_id` (string) — archdiocese reference
- `field_last_scraped` (datetime) — last successful extraction
- `field_data_confidence` (list_string) — confirmed / provisional / stale
- `field_manually_edited` (boolean) — prevents automated overwrites
- `field_parish_status` (list_string) — active / closed / merged

**Paragraph type: Mass Time (`mass_time`)**
- `field_day` (list_string) — Monday through Sunday
- `field_time` (string) — HH:MM format
- `field_mass_type` (entity_reference → taxonomy) — Regular, Vigil, Holy Day, Reconciliation
- `field_language` (entity_reference → taxonomy) — English, Italian, Vietnamese, Latin, etc.
- `field_notes` (text) — e.g., "First Friday only", "School term only"
- `field_effective_from` (date) — when this time starts
- `field_effective_until` (date) — when this time ends (null = ongoing)

**Taxonomy: Mass Type (`mass_type`)**
- Regular Mass, Vigil Mass, Holy Day Mass, Reconciliation, Adoration, Latin Rite, Special

**Taxonomy: Language (`mass_language`)**
- English, Italian, Vietnamese, Latin, Polish, Croatian, Other

### 7.2 Pipeline tables (custom, managed via `mass_times.install`)

```sql
-- Source endpoints discovered for each parish
mass_times_source_endpoints (
  id INT AUTO_INCREMENT PRIMARY KEY,
  parish_nid INT NOT NULL,              -- Drupal node ID
  source_type VARCHAR(32) NOT NULL,     -- ical_feed, structured_data, website_page, pdf_bulletin, facebook_page
  url TEXT NOT NULL,
  check_frequency_hours INT DEFAULT 48,
  last_checked_at DATETIME,
  last_changed_at DATETIME,
  is_primary TINYINT DEFAULT 0,
  status VARCHAR(16) DEFAULT 'active',  -- active, broken, retired
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Parish extraction templates
mass_times_templates (
  id INT AUTO_INCREMENT PRIMARY KEY,
  parish_nid INT NOT NULL,
  template_json LONGTEXT NOT NULL,
  accuracy_score DECIMAL(5,4),
  build_method VARCHAR(16) DEFAULT 'automated', -- automated, manual, llm_assisted
  version INT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  superseded_at DATETIME
);

-- Extraction audit log
mass_times_extractions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  parish_nid INT NOT NULL,
  source_endpoint_id INT,
  extraction_tier TINYINT NOT NULL,     -- 1, 2, or 3
  raw_content_hash VARCHAR(64),         -- SHA256 of fetched content
  raw_content_path TEXT,                -- path in mt/data/
  extracted_json LONGTEXT,
  confidence_score DECIMAL(5,4),
  validation_status VARCHAR(16),        -- confirmed, provisional, flagged
  llm_model VARCHAR(64),               -- which model was used (NULL for Tier 1-2)
  llm_cost_usd DECIMAL(8,6),           -- API cost for this extraction (0 for Tier 1-2)
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Change tracking between extractions
mass_times_diffs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  extraction_id INT NOT NULL,
  previous_extraction_id INT,
  changes_json LONGTEXT,
  change_type VARCHAR(16),              -- none, minor, major
  reviewed_by INT,                      -- Drupal user ID
  reviewed_at DATETIME
);

-- User correction reports
mass_times_user_reports (
  id INT AUTO_INCREMENT PRIMARY KEY,
  parish_nid INT NOT NULL,
  report_type VARCHAR(32),              -- wrong_time, missing_mass, closed, other
  description TEXT,
  reporter_email VARCHAR(255),
  status VARCHAR(16) DEFAULT 'new',     -- new, investigating, resolved, dismissed
  resolution_notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  resolved_at DATETIME
);
```

---

## 8. NWP Configuration

### 8.1 nwp.yml section

```yaml
# === MASS TIMES SCRAPER [EXPERIMENTAL] ===
# Automated Catholic mass times scraping for mt.nwpcode.org (F16)
# Requires API keys in .secrets.yml
mass_times:
  enabled: false
  schedule: "0 3 * * *"             # Default cron: 3am daily
  timezone: Australia/Sydney

  # Geographic scope
  centre_lat: -37.8131              # Ringwood, Melbourne
  centre_lng: 145.2285
  radius_km: 20

  # LLM settings (Tier 3 fallback only)
  fallback_model: claude-sonnet-4-5  # Model for Tier 3 LLM fallback
  max_monthly_llm_usd: 5            # Monthly LLM cost cap (low — most extraction is code-based)
  tier3_daily_limit: 10             # Max Tier 3 extractions per day

  # Email notifications
  alert_on_failure: true
  weekly_summary: true
  summary_day: friday

  # Drupal sync
  drupal_site: mt
  drupal_api_user: mass_times_bot
  sync_after_extraction: true
```

### 8.2 .secrets.yml section

```yaml
# Mass times scraper credentials (F16)
mass_times:
  claude_api_key: ""                 # Claude API key for Tier 3 LLM fallback
  google_places_api_key: ""          # Google Places API key for parish discovery
  drupal_api_password: ""            # Password for mass_times_bot Drupal user
```

### 8.3 Site entry in nwp.yml

```yaml
sites:
  mt:
    directory: /home/rob/nwp/sites/mt
    recipe: d                         # Standard Drupal
    environment: development
    created: 2026-02-10T00:00:00Z
    purpose: indefinite
    installed_modules:
      - drupal/geofield
      - drupal/geocoder
      - drupal/leaflet
      - drupal/search_api
      - drupal/paragraphs
      - drupal/pathauto
      - drupal/metatag
      - drupal/simple_sitemap
      - drupal/webform
      - drupal/jsonapi_extras
      - drupal/restui
    live:
      enabled: true
      domain: mt.nwpcode.org
      server_ip: ""                   # Shared Linode
      linode_id: shared
      type: shared
```

---

## 9. Drupal Module: mass_times

### 9.1 Module structure (follows `avc_moodle` pattern)

```
modules/mass_times/
├── mass_times.info.yml              # Module metadata
├── mass_times.module                # Hook implementations
├── mass_times.install               # Schema for pipeline tables
├── mass_times.routing.yml           # Routes
├── mass_times.services.yml          # Service definitions
├── mass_times.permissions.yml       # Permissions
├── mass_times.links.menu.yml        # Admin menu links
├── config/
│   ├── install/
│   │   ├── mass_times.settings.yml          # Default settings
│   │   ├── node.type.parish.yml             # Parish content type
│   │   ├── field.storage.*.yml              # Field storage definitions
│   │   ├── field.field.*.yml                # Field instance definitions
│   │   ├── taxonomy.vocabulary.mass_type.yml
│   │   ├── taxonomy.vocabulary.mass_language.yml
│   │   └── views.view.parish_listing.yml    # Default views
│   └── optional/
│       └── views.view.parish_map.yml
└── src/
    ├── Controller/
    │   └── MassTimesController.php          # Page callbacks
    ├── Form/
    │   └── SettingsForm.php                 # Admin settings form
    ├── Plugin/
    │   └── Block/
    │       ├── NextMassBlock.php            # "Next mass near you" block
    │       ├── ParishMapBlock.php           # Map display block
    │       └── UpcomingChangesBlock.php     # Alerts/changes block
    ├── Service/
    │   ├── ParishDataService.php            # Data access layer
    │   └── ProximityService.php             # Geographic queries
    └── Commands/
        └── MassTimesCommands.php            # Drush commands
```

### 9.2 Drush commands

```bash
drush mass-times:status              # Show extraction status for all parishes
drush mass-times:scrape [parish]     # Trigger immediate scrape for a parish
drush mass-times:rebuild [parish]    # Trigger template rebuild for a parish
drush mass-times:import              # Import data from Python pipeline
drush mass-times:report              # Generate summary report
```

### 9.3 User-facing features

- 9.3.1 **Homepage:** Interactive map centred on Ringwood showing all parishes as pins. Each pin shows parish name and next mass time on hover. Colour-coded by data freshness (green = updated this week, amber = 1-2 weeks, red = stale).
- 9.3.2 **Search by proximity:** "Show masses within [5/10/15/20] km of [location]" — defaults to Ringwood, allows postcode or suburb entry.
- 9.3.3 **Search by time:** "Show masses today after 5pm", "Show Sunday morning masses", "Show weekday masses before 9am".
- 9.3.4 **Parish detail page:** Full weekly schedule in a clean table, address with map, link to parish website, last-updated timestamp, confidence indicator, "Report incorrect time" button.
- 9.3.5 **"Next mass near me":** Geolocation-based query (with user permission) showing the soonest upcoming mass within chosen radius. Primary mobile use case.
- 9.3.6 **Alerts feed:** Upcoming changes, cancellations, holiday schedules pulled from change indicator scanning.
- 9.3.7 **Mobile-first responsive design** — the primary use case is someone on their phone looking for a mass.

---

## 10. Bash Wrapper & Deployment

### 10.1 mass-times.sh (main script)

Follows the `fin-monitor.sh` pattern:

```bash
#!/bin/bash
set -euo pipefail

# Sources lib/ui.sh for NWP UI functions
# Loads mass-times.conf (generated from nwp.yml by deploy script)
# Delegates to Python pipeline via venv

# Options:
#   --discover          Run parish discovery
#   --build [parish]    Build/rebuild extraction template
#   --extract           Run extraction cycle
#   --status            Show system status
#   --report            Generate summary report
#   --check             Dry run (no writes)
#   --help              Show help
```

### 10.2 deploy-mass-times.sh

Follows the `deploy-fin-monitor.sh` pattern:

- Reads `nwp.yml` for configuration using `yq`.
- Reads `.secrets.yml` for API keys.
- Generates `mass-times.conf`.
- Deploys via rsync to the Linode server (same as fin-monitor).
- Rsyncs `mt/` directory and required `lib/` files.
- Runs `setup-mass-times.sh` on the server.

### 10.3 setup-mass-times.sh

Follows the `setup-fin-monitor.sh` pattern:

- Creates Python venv in `mt/.venv/`.
- Installs dependencies: `httpx`, `beautifulsoup4`, `pdfplumber`, `pytesseract`, `playwright`, `anthropic`, `geopy`, `icalendar`, `extruct`, `Pillow`.
- Installs Playwright browsers (`playwright install chromium`).
- Creates `run-mass-times.sh` wrapper.
- Installs cron job (default: daily at 3am AEST).
- Tests API connectivity (Google Places API, optionally Claude API).
- Tests email delivery.

### 10.4 pl integration

```bash
pl mass-times status                 # System status
pl mass-times extract                # Run extraction cycle
pl mass-times discover               # Run parish discovery
pl mass-times build sacred-heart     # Build/rebuild template for a parish
pl mass-times report                 # Generate summary report
```

Implemented via `lib/mass-times.sh` sourced by the `pl` command framework, delegating to `mt/mass-times.sh`.

---

## 11. Monitoring & Quality Assurance

### 11.1 Automated monitoring

- 11.1.1 Extraction success rate per parish, tracked in `mass_times_extractions` table.
- 11.1.2 Email alert if a parish has not been successfully scraped in 7+ days.
- 11.1.3 Email alert if a parish's source URL returns 404 (likely site redesign — triggers template rebuild).
- 11.1.4 Weekly summary email (configurable day in `nwp.yml`): parishes updated, tier distribution, issues found, user reports received, LLM cost to date.

### 11.2 Quality metrics

- 11.2.1 Extraction accuracy over time (confirmed correct vs user-reported incorrect).
- 11.2.2 LLM cost per month (tracked in `mass_times_extractions.llm_cost_usd` — target: near zero for most months).
- 11.2.3 Tier distribution — target: >50% Tier 1, 40-45% Tier 2, <10% Tier 3.
- 11.2.4 Data freshness: percentage of parishes updated within the past 7 days.
- 11.2.5 Template stability: how often templates need rebuilding (lower = better).

### 11.3 Drupal admin dashboard

- 11.3.1 Custom admin page at `/admin/mass-times` showing: parish count, extraction stats (by tier), recent failures, pending user reports.
- 11.3.2 Flagged extractions appear in a moderation queue — reviewer can confirm, correct, or dismiss.
- 11.3.3 Corrections feed back into template calibration (updated baseline times).

---

## 12. Cost Estimates

### 12.1 LLM costs

| Activity | Model | Per-unit cost | Frequency | Monthly cost |
|---|---|---|---|---|
| Tier 1 extraction (static confirm) | None | $0 | ~350/month (50% of 35 parishes x 20 extractions) | $0 |
| Tier 2 extraction (code-based) | None | $0 | ~280/month (40%) | $0 |
| Tier 3 extraction (LLM fallback) | Sonnet | ~$0.01 | ~70/month (<10%) | ~$0.70 |
| Template building (one-time) | None | $0 | 35 parishes (one-time, code-based) | $0 |
| Template rebuild (format changes) | None | $0 | ~2/month (code-based) | $0 |
| **Monthly total (steady state)** | | | | **~$1** |

### 12.2 Infrastructure costs

| Item | Cost |
|---|---|
| Linode shared hosting (existing NWP server) | $0 incremental |
| Google Places API (discovery, one-time) | Free tier sufficient |
| Domain (mt.nwpcode.org subdomain) | $0 (existing domain) |
| SSL (Let's Encrypt) | $0 |
| **Monthly total (steady state)** | **~$1 (LLM fallback only)** |

### 12.3 Cost comparison with AI-first approach

| Approach | One-time cost | Monthly cost | Annual cost |
|---|---|---|---|
| **Code-first (this proposal)** | ~$0 | ~$1 | ~$12 |
| AI-first (LLM for every extraction) | ~$35 (learning) | ~$8 | ~$131 |

The code-first approach costs ~91% less annually because the template building phase and routine extraction are both code-based.

---

## 13. Implementation Phases

### Phase 1 — Foundation & Discovery

- 13.1.1 Create `mt/` directory structure following `fin/` pattern.
- 13.1.2 Set up Python environment and dependencies.
- 13.1.3 Add `mass_times` configuration section to `nwp.yml` and `.secrets.yml`.
- 13.1.4 Build the time/day regex parser module (`src/parser.py`) with comprehensive test suite against fixture data.
- 13.1.5 Build parish discovery module (`src/discovery.py`).
- 13.1.6 Run discovery and manually verify the parish list.
- 13.1.7 Create `lib/mass-times.sh` for `pl` integration.

### Phase 2 — Template Building

- 13.2.1 Build web scraper and PDF downloader (`src/scraper.py`).
- 13.2.2 Collect 3-4 recent bulletins/pages per parish.
- 13.2.3 Build the template builder (`src/template_builder.py`):
  - iCal detection and parsing.
  - Structured data detection and parsing.
  - Web page CSS selector identification.
  - PDF bounding region identification.
  - Static/dynamic section classification via multi-bulletin diffing.
- 13.2.4 Generate templates for all ~35 parishes.
- 13.2.5 Validate templates against held-out data; manually adjust for parishes with accuracy < 85%.

### Phase 3 — Extraction Pipeline

- 13.3.1 Build three-tier extraction engine (`src/extractor.py`).
- 13.3.2 Build validation module (`src/validator.py`).
- 13.3.3 Build bash wrapper (`mass-times.sh`) and setup/deploy scripts.
- 13.3.4 Run extraction across all parishes, validate results.
- 13.3.5 Iterate on templates for parishes with accuracy < 90%.

### Phase 4 — Drupal Site

- 13.4.1 Create Drupal site via `pl install mt`.
- 13.4.2 Build `modules/mass_times/` module with content types, fields, taxonomies.
- 13.4.3 Build Drupal sync module (`src/drupal_sync.py`) using JSON:API.
- 13.4.4 Build Views: parish listing, parish map, time-based search.
- 13.4.5 Build blocks: Next Mass, Parish Map, Upcoming Changes.
- 13.4.6 Build "Report incorrect time" webform.
- 13.4.7 Mobile-first responsive theming.

### Phase 5 — Deployment & Launch

- 13.5.1 Deploy Drupal site to mt.nwpcode.org via `pl live mt`.
- 13.5.2 Deploy extraction pipeline to server via `deploy-mass-times.sh`.
- 13.5.3 Configure DNS for mt.nwpcode.org via Cloudflare (existing NWP process).
- 13.5.4 Set up monitoring and email alerts.
- 13.5.5 Run 2 weeks in shadow mode (extract but flag all data as provisional).
- 13.5.6 Review shadow mode results, fix issues, then switch to live publication.

### Phase 6 — Ongoing Maintenance

- 13.6.1 Enable format change detection and automatic template rebuilding.
- 13.6.2 Enable user feedback processing loop.
- 13.6.3 After 6+ months: build seasonal pattern detection from historical data.
- 13.6.4 Monthly parish discovery refresh.

---

## 14. Testing Strategy

### 14.1 Python tests (in `mt/tests/`)

- Unit tests for parser module: test all time regex patterns against 50+ real-world format variations (e.g., "9:30am", "9.30 AM", "9:30 a.m.", "0930", "9am").
- Unit tests for template builder: test CSS selector identification, PDF region detection, static/dynamic classification.
- Unit tests for extractor: test each tier against fixture data.
- Integration tests against fixture bulletins (anonymised copies of real parish bulletins in various formats).
- Mock tests for Claude API calls (test prompt formatting and response parsing without API costs).

### 14.2 Drupal tests

- PHPUnit tests for `ParishDataService` and `ProximityService`.
- Functional tests for content type creation and JSON:API endpoints.
- Behat tests for user-facing search and map features.

### 14.3 BATS tests (in `tests/`)

- Following existing NWP BATS pattern.
- Test `mass-times.sh` CLI options and argument parsing.
- Test `deploy-mass-times.sh` config generation.
- Test `pl mass-times` integration.

### 14.4 End-to-end validation

- Weekly automated run: extract from all parishes, compare against manually verified "ground truth" for 5 reference parishes.
- Track accuracy trend over time.

---

## 15. Security Considerations

- 15.1 API keys stored in `.secrets.yml` (infrastructure-safe tier), never in code or nwp.yml.
- 15.2 Drupal API user (`mass_times_bot`) has minimal permissions: create/edit Parish nodes only.
- 15.3 User-submitted reports are sanitised before storage (prevent XSS in report descriptions).
- 15.4 Scraping respects `robots.txt` and rate limits to avoid being blocked or causing load on parish sites.
- 15.5 No personal data collected from users beyond optional email on correction reports.
- 15.6 Raw bulletin content archived locally only (not publicly accessible).

---

## 16. Future Possibilities (Out of Scope for F16)

- 16.1 Expand beyond 20km radius or to other centres (e.g., CBD, Geelong).
- 16.2 Push notifications for mass time changes at "favourite" parishes.
- 16.3 Integration with Google Calendar / Apple Calendar (iCal export per parish).
- 16.4 Multi-diocese support (beyond Melbourne Archdiocese).
- 16.5 Confession/reconciliation times as a separate tracked entity.
- 16.6 Community-contributed parish photos and accessibility information.

---

## 17. Decision Log

| # | Decision | Rationale |
|---|---|---|
| D1 | Python pipeline + Drupal display (not all-in-Drupal) | Python is stronger for scraping, PDF parsing, and structured extraction. Drupal excels at content management and display. |
| D2 | Follow `fin/` directory pattern | Proven pattern in NWP for Python-based scheduled tasks with bash wrappers. |
| D3 | Follow `avc_moodle` module pattern | Proven pattern in NWP for custom Drupal modules with services, commands, and API integration. |
| D4 | MariaDB (not PostgreSQL + PostGIS) | NWP standard database. Geofield module handles geographic queries without PostGIS. |
| D5 | Code-first extraction (not LLM-for-everything) | Parish formats are repetitive and structured. Regex, CSS selectors, and PDF region extraction handle 90%+ of cases deterministically, cheaper, faster, and more reliably than LLM calls. |
| D6 | Parish Extraction Templates (built by code) | Automated structural analysis of a few bulletins builds a reusable template. No LLM needed for template creation — PDF coordinate extraction, regex pattern detection, and multi-document diffing are sufficient. |
| D7 | JSON:API for Python→Drupal sync | Drupal core module, no additional dependencies. Follows REST patterns used by `avc_moodle`. |
| D8 | iCal and structured data as top-priority sources | Machine-readable sources need no template building and no LLM at all. Detect these first and only fall back to HTML/PDF parsing when structured sources are unavailable. |
| D9 | Sonnet as LLM fallback, no Opus tier | Sonnet is sufficient for extracting structured data from text. Opus adds cost without meaningful accuracy improvement for this task. If Sonnet fails, flag for manual review rather than spending more on Opus. |
| D10 | Template building replaces "learning phase" | The original design used Claude Opus to "learn" each parish at ~$1/parish. Automated template building achieves the same result at $0/parish using PDF parsing and regex analysis. |

---

Last Updated: 2026-02-12
