################################################################################
# NWP Cron Configuration
################################################################################
#
# Comprehensive cron configuration for NWP including:
#   - Automated backups with retention policies
#   - Site monitoring and health checks
#   - Maintenance tasks
#   - Security checks
#
# Installation:
#   1. Copy this file to /etc/cron.d/nwp (requires root)
#      sudo cp nwp-cron.conf /etc/cron.d/nwp
#
#   2. Or add entries to user's crontab:
#      crontab -e
#      (paste the entries below)
#
#   3. Update SCRIPT_DIR to match your installation path
#
# Cron Format:
#   * * * * * user command
#   │ │ │ │ │
#   │ │ │ │ └─── Day of week (0-7, Sunday=0 or 7)
#   │ │ │ └───── Month (1-12)
#   │ │ └─────── Day of month (1-31)
#   │ └───────── Hour (0-23)
#   └─────────── Minute (0-59)
#
# Notes:
#   - All times are in server's local timezone
#   - Output is typically sent via email (configure system mail)
#   - To suppress output, add: > /dev/null 2>&1
#   - To log output: >> /var/log/nwp/cron.log 2>&1
#
################################################################################

# Required environment variables for cron jobs
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

# Script directory (update this path as needed)
SCRIPT_DIR=/root/nwp-server-scripts

################################################################################
# AUTOMATED BACKUPS
################################################################################
#
# NWP uses a tiered backup strategy with different retention policies:
#
#   Database backups: Every 6 hours, retain 24 backups (~1 day)
#   File backups:     Daily at 2 AM, retain 7 backups (1 week)
#   Full backups:     Weekly Sunday 3 AM, retain 4 backups (1 month)
#
# Backup locations:
#   /var/backups/nwp/hourly  - Database backups
#   /var/backups/nwp/daily   - File backups
#   /var/backups/nwp/weekly  - Full backups (database + files + uploads)
#
################################################################################

# Database backup every 6 hours (00:00, 06:00, 12:00, 18:00)
0 */6 * * * root $SCRIPT_DIR/nwp-scheduled-backup.sh prod database >> /var/log/nwp/backup-cron.log 2>&1

# File backup daily at 2:00 AM
0 2 * * * root $SCRIPT_DIR/nwp-scheduled-backup.sh prod files >> /var/log/nwp/backup-cron.log 2>&1

# Full backup weekly on Sunday at 3:00 AM (with verification)
0 3 * * 0 root $SCRIPT_DIR/nwp-scheduled-backup.sh prod full --verify >> /var/log/nwp/backup-cron.log 2>&1

################################################################################
# HEALTH CHECKS AND MONITORING
################################################################################

# Production Site Monitoring (Every 5 Minutes)
# Monitors the production site every 5 minutes with full alerting enabled.
# Alerts are triggered for:
#   - HTTP status codes != 200/301/302
#   - Response time > 5 seconds
#   - Disk usage > 90%
*/5 * * * * nwp /usr/local/bin/nwp-monitor.sh --domain example.com --alert-http --alert-time 5 --alert-disk 90 --notify /usr/local/bin/nwp-notify.sh /var/www/prod >> /var/log/nwp/monitor.log 2>&1

# Health check every 5 minutes (alternate monitoring approach)
# Uses nwp-healthcheck.sh for comprehensive site health verification
*/5 * * * * root $SCRIPT_DIR/nwp-healthcheck.sh --site prod --quiet >> /var/log/nwp/healthcheck.log 2>&1

################################################################################
# Test/Staging Site Monitoring (Every 15 Minutes)
################################################################################
#
# Monitors the test/staging site less frequently.
# Useful for catching issues before they reach production.

*/15 * * * * nwp /usr/local/bin/nwp-monitor.sh --domain test.example.com --alert-http --alert-time 10 --alert-disk 90 /var/www/test >> /var/log/nwp/monitor-test.log 2>&1

################################################################################
# Hourly Monitoring Summary
################################################################################
#
# Generates a summary of metrics once per hour at the top of the hour.
# This can be used to analyze trends or create reports.

0 * * * * nwp /usr/local/bin/nwp-monitor.sh --domain example.com /var/www/prod

################################################################################
# Daily Health Check (6 AM)
################################################################################
#
# Runs a comprehensive health check once per day at 6 AM.
# Combines monitoring with the full health check suite.

0 6 * * * root $SCRIPT_DIR/nwp-healthcheck.sh --domain example.com /var/www/prod >> /var/log/nwp/healthcheck.log 2>&1

################################################################################
# MAINTENANCE TASKS
################################################################################

# Clear Drupal cache nightly at 1:00 AM
# Prevents cache bloat and ensures fresh start each day
0 1 * * * root cd /var/www/prod && sudo -u www-data ./vendor/bin/drush cr >> /var/log/nwp/maintenance.log 2>&1

# Run Drupal cron every hour
# Executes scheduled Drupal tasks (node access, search indexing, etc.)
0 * * * * root cd /var/www/prod && sudo -u www-data ./vendor/bin/drush cron >> /var/log/nwp/drupal-cron.log 2>&1

# Clean up old logs weekly on Monday at 4:00 AM
# Removes logs older than 30 days to save disk space
0 4 * * 1 root find /var/log/nwp -name "*.log" -mtime +30 -delete >> /var/log/nwp/cleanup.log 2>&1

# Clean up old metric files weekly on Sunday at 2:00 AM
# Removes metrics older than 30 days
0 2 * * 0 root find /var/log/nwp/metrics -name "metrics-*.jsonl" -mtime +30 -delete 2>&1

# Rotate backup logs weekly on Monday at 4:30 AM
# Prevents backup log from growing too large
30 4 * * 1 root if [ -f /var/log/nwp/backup-cron.log ]; then mv /var/log/nwp/backup-cron.log /var/log/nwp/backup-cron.log.$(date +\%Y\%m\%d) && touch /var/log/nwp/backup-cron.log; fi 2>&1

################################################################################
# Alternative: Simple Monitoring Without Alerts
################################################################################
#
# If you want to collect metrics without triggering alerts, omit the --alert-*
# flags and --notify option. Useful for establishing baseline metrics.

# */5 * * * * nwp /usr/local/bin/nwp-monitor.sh --domain example.com /var/www/prod

################################################################################
# Monitoring with Custom Thresholds
################################################################################
#
# Adjust thresholds based on your site's characteristics:
#   - Fast site: --alert-time 2
#   - Slower site: --alert-time 10
#   - Low disk space warning: --alert-disk 80
#   - Critical disk space: --alert-disk 95

# */5 * * * * nwp /usr/local/bin/nwp-monitor.sh --domain example.com --alert-time 2 --alert-disk 80 /var/www/prod

################################################################################
# Monitoring Multiple Sites
################################################################################
#
# If you host multiple sites on the same server, add a cron entry for each.
# Use different log files to separate metrics.

# Site 1
# */5 * * * * nwp /usr/local/bin/nwp-monitor.sh --domain site1.com --alert-http /var/www/site1 >> /var/log/nwp/monitor-site1.log 2>&1

# Site 2
# */5 * * * * nwp /usr/local/bin/nwp-monitor.sh --domain site2.com --alert-http /var/www/site2 >> /var/log/nwp/monitor-site2.log 2>&1

################################################################################
# OPTIONAL: Security and Monitoring Enhancements
################################################################################

# Check disk space every hour and alert if > 80% full
# Prevents server from running out of disk space
# 0 * * * * root df -h / | awk 'NR==2 {if (int($5) > 80) print "WARNING: Disk usage is " $5}' | $SCRIPT_DIR/nwp-notify.sh --event disk_space_warning --site prod --severity warning >> /var/log/nwp/monitoring.log 2>&1

# Check for Drupal security updates daily at 6:00 AM
# Notifies if security updates are available (does not auto-update)
# 0 6 * * * root cd /var/www/prod && ./vendor/bin/drush pm:security --format=json | grep -q 'SECURITY' && $SCRIPT_DIR/nwp-notify.sh --event security_updates_available --site prod --severity warning --message "Drupal security updates available" >> /var/log/nwp/security.log 2>&1

# Sync backups to object storage daily at 4:00 AM
# Ensures off-site backup copy for disaster recovery (requires s3cmd configured)
# 0 4 * * * root s3cmd sync /var/backups/nwp/ s3://nwp-backups/$(hostname)/ >> /var/log/nwp/backup-sync.log 2>&1

# Verify yesterday's backups daily at 5:00 AM
# Reviews backups and alerts if verification fails
# 0 5 * * * root $SCRIPT_DIR/nwp-verify-backup.sh /var/backups/nwp/hourly/prod_database_*.sql.gz --verbose || $SCRIPT_DIR/nwp-notify.sh --event backup_verification_failed --site prod --severity error >> /var/log/nwp/monitoring.log 2>&1

################################################################################
# Testing Your Cron Configuration
################################################################################
#
# Before deploying, test your scripts manually:
#
#   # Test backup script
#   sudo $SCRIPT_DIR/nwp-scheduled-backup.sh prod database --verbose
#
#   # Test monitoring script
#   sudo -u nwp /usr/local/bin/nwp-monitor.sh --domain example.com --verbose /var/www/prod
#
#   # Test notification script
#   sudo $SCRIPT_DIR/nwp-notify.sh --event test --site prod --message "Test notification"
#
# Verify the scripts run without errors and check that:
#   1. Backups are created in /var/backups/nwp/
#   2. Metrics are logged to /var/log/nwp/metrics/
#   3. Alerts are triggered correctly
#   4. Notifications are sent (if configured)
#
# Check cron execution:
#   - View cron logs: grep CRON /var/log/syslog
#   - Check backup logs: tail -f /var/log/nwp/backup-cron.log
#   - Check monitoring logs: tail -f /var/log/nwp/monitor.log
#   - List installed cron jobs: crontab -l
#
# Installation:
#   1. Update SCRIPT_DIR to match your installation
#   2. Update domain names in monitoring jobs
#   3. Create log directory: sudo mkdir -p /var/log/nwp && sudo chmod 755 /var/log/nwp
#   4. Install: sudo crontab -u root nwp-cron.conf
#      OR manually add desired entries: sudo crontab -e
#
################################################################################
